
%%% ../preamble.tex %%%
% Templates: 82ccb576e4df24e5eac4194b76230be360b4f733

% to be `\input` in subfolders,
% ... therefore the path should be relative to subfolders.

\usepackage{iftex}
\ifPDFTeX
\else
	\usepackage[UTF8
		,heading=false
		,scheme=plain % English Document
	]{ctex}
\fi
%\ctexset{autoindent=true}
\usepackage{indentfirst}


%%% ../.modules/basics/macros.tex %%%
% Simple macros / shorthands for LaTeX,
% ... compatible with MathJax
% ... loaded before 'mathjax.tex'
%
% Generics
\newcommand{\mbb}[1]{\mathbb{#1}}
\newcommand{\mrm}[1]{\mathrm{#1}}
\newcommand{\mcal}[1]{\mathcal{#1}}
\newcommand{\mscr}[1]{\mathscr{#1}}
\newcommand{\mfrak}[1]{\mathfrak{#1}}
\newcommand{\tup}[1]{\textup{#1}}
\newcommand{\mop}[1]{\operatorname{#1}}
%
% Utils
\newcommand{\idty}{\mathds{1}}
\newcommand{\proj}[1]{\mop{proj_{\mathit{#1}}}}
\newcommand{\textbox}[1]{\fbox{#1}}
\newcommand{\rvec}[1]{\overrightarrow{#1}}
\newcommand{\lvec}[1]{\overleftarrow{#1}}
\newcommand{\sidenote}[1]{\textcolor{purple}{#1}}
\newcommand{\mquote}[1]{\text{``$#1$''}}
\newcommand{\thinmspace}[1][.5]{\mspace{#1\thinmuskip}}
\newcommand{\moppower}[2]{\mop{ {#1}^{#2} }\!}
%
% Physics
\newcommand{\DD}[1]{\mathinner{\mscr{D}{#1}}}
\newcommand{\normorder}[1]{
	\mspace{.2\thinmuskip}%
	{\mathopen {:}}%
	{\mspace{.8\thinmuskip}#1\mspace{.8\thinmuskip}}%
	{\mathclose {:}}%
	\mspace{.5\thinmuskip}%
}
%
% Differential Geometry
\newcommand{\hodgedual}{\mop{\star}}
\newcommand{\hstar}{\mop{\star}}
\newcommand{\cdd}{\mop{D}\!}
\newcommand{\pdd}[1]{\partial_{#1}}
\newcommand{\cdv}[1]{\nabla_{\!\mathnormal{#1}}}
\newcommand{\ldv}[1]{\mcal{L}_{\mathnormal{#1}}}
\newcommand{\ric}[1]{\mop{Ric}\pqty{#1}}
\newcommand{\ad}{\mop{ad}}
\newcommand{\pd}{\partial}
\newcommand{\pdbar}{\bar{\partial}}
%
% Algebra
\newcommand{\subsetnormal}{\mathrel{\triangleleft}}
\newcommand{\Hom}{\mop{Hom}}
\newcommand{\To}{\Rightarrow}
\newcommand{\longto}{\longrightarrow}
\newcommand{\Longto}{\Longrightarrow}
%
% QED
\newcommand{\qednow}[1][]{\hfill\ensuremath{ %
    \square\mathrlap{_{\,#1}}%
}}
\newcommand{\qedfull}[1][]{\hfill\ensuremath{ %
    \blacksquare\mathrlap{_{\,#1}}%
}}

%%% ../.modules/preamble_base.tex %%%
% Unlimited fonts
	\def\hmmax{0}
	\def\bmmax{0}
% Utils
	\PassOptionsToPackage{hyphens}{url} % before hyperref
	\usepackage{hyperref} % set option with \hypersetup
	\usepackage{uri} % \arxiv
	\usepackage{ccicons} % creative commons
	\usepackage[super]{nth} % nth superscript
	\usepackage[datesep=/]{datetime2} % modify \today
	\usepackage[space]{grffile} % file name fix
	\usepackage{etoolbox,environ,iftex}
	\usepackage{chngcntr}
%	\counterwithout{equation}{section}
	\newcommand{\wiki}[1]{%
		\texttt{Wikipedia:}\,\textit{#1}%
	}
	\newcommand{\wikiref}[2]{\wiki{\href{#1}{#2}}}
	\newcommand{\https}[1]{%
		\href{https://#1}{\nolinkurl{#1}}%
	}
	\newcommand{\http}[1]{%
		\href{http://#1}{\nolinkurl{#1}}%
	}
% Page
	% parskip backup
	\newlength{\parskipbackup}
	\setlength{\parskipbackup}{\parskip}
	% parskip setting
	\setlength{\parskip}{.3\baselineskip}
	% parskip backup
	\newlength{\parskipnorm}
	\setlength{\parskipnorm}{\parskip}
	% baseline
%	\renewcommand{\baselinestretch}{1.05}
	% footnote
	\interfootnotelinepenalty=10000 % forbid footnote spanning pages
% Chinese
	\ifPDFTeX
		\usepackage[utf8]{inputenc}
		\usepackage{CJKutf8}
		\newcommand{\cjk}[2][gbsn]{%
			\begin{CJK}{UTF8}{#1}%
			#2%
			\end{CJK}%
		}  % CJK* swallows whitespace between chars
		\newcommand{\textkai}[1]{\cjk[gkai]{#1}}
	\else
		\usepackage[UTF8
			,heading=false
%			,scheme=plain
		]{ctex}
%		\usepackage{indentfirst} % when scheme=plain
		\newcommand{\cjk}[2][]{#2}
		\newcommand{\textkai}[1]{{\kaishu #1}}
	\fi
	\ifXeTeX
		\newcommand{\cjkverb}[1]{%
			\texttt{\xeCJKVerbAddon #1}
		} % CJK verbatim
	\fi
% Presentation
	\PassOptionsToPackage{%
		table,svgnames,dvipsnames
	}{xcolor}
	\usepackage{xcolor}
	\usepackage{graphicx}
%	\usepackage{wrapfig,subfig}
	\usepackage{svg}
	\usepackage[export]{adjustbox}
	\usepackage[above]{placeins} % \FloatBarrier
	\usepackage{tikz}
%	\usepackage{tikz-cd} % Commutative diagram
%	\usepackage{tkz-euclide} % Euclidaen geometry
	\usetikzlibrary{arrows.meta}
% Code
%	\usepackage{minted}
%	\usemintedstyle{colorful}
% Tables
	\usepackage{booktabs,tabularx,multirow,bigstrut}
%	\usepackage{dcolumn}
	\newcolumntype{C}[1]{>{%
		\hsize=#1\hsize\centering\arraybackslash%
	}X}
	\newcolumntype{W}[1]{>{%
		\hsize=#1\hsize\arraybackslash%
	}X}
	\newcolumntype{^}{>{\rowstyle}}
	\newcommand{\setrowstyle}[1]{%
		\gdef\rowstyle{#1}%
		#1\ignorespaces%
	}
	\newcolumntype{~}{>{\global\let\rowstyle\relax}}
% Math & Fonts
	\let\latexointop\ointop
	\usepackage{mathtools,amssymb,latexsym,bm % basics
		,physics,siunitx,slashed,tensor % physics
		,simpler-wick,simplewick % wick
		,esint,nicefrac,extarrows % more symbols
		,calligra,romannum,dsfont,fourier-orns % nice fonts
%		,upgreek,textcomp % more fonts
		,eqnarray,resizegather,empheq % more envs
		,relsize,stackengine % utils
	}
%	\usepackage{wasysym}
%	\usepackage{amsthm}
	\usepackage[g]{esvect}
%	\usepackage[mathscr]{eucal}
	\usepackage[scr=esstix]{mathalfa}
	\usepackage[only,sslash]{stmaryrd}
	% math display
	\let\id\indices
	\newcommand*\nicebox[1]{%
		\fbox{\hspace{1em}\addstackgap[5pt]{#1}\hspace{1em}}%
	}
	\empheqset{box=\nicebox}
	\mathtoolsset{showonlyrefs,showmanualtags}
	\resizegathersetup{equations=false}
	\numberwithin{equation}{section}
%	\counterwithout{equation}{section}
	\allowdisplaybreaks[2]
	\sisetup{%
		redefine-symbols=false
		,separate-uncertainty=true
		,range-phrase=\,\textasciitilde\,
		,arc-separator=\,
	}
% Tweaks
	% math line spacing
	\newlength{\djot}
	\setlength{\djot}{\jot}
	\newcommand{\restorejot}{\setlength{\jot}{\djot}}
	% legacy \oint
	\let\ointop\undefined
	\let\ointop\latexointop
	% calligra
	\DeclareMathAlphabet{\mathcalligra}{T1}{calligra}{m}{n}
	\DeclareFontShape{T1}{calligra}{m}{n}{<->s*[2.2]callig15}{}
	% cosmetics
	\newcommand\inlineeqno{\stepcounter{equation}\ (\theequation)}
	\newcommand\scalemath[2]{\scalebox{#1}{\mbox{\ensuremath{\displaystyle #2}}}}
	\newcommand\raisemath[2]{\raisebox{#1\depth}{${#2}$}}
% Commands
	% brackets
	\DeclarePairedDelimiter\aqty{\langle}{\rangle}
	\DeclarePairedDelimiterX\inprod[2]{\langle}{\rangle}{#1,#2}
	\let\ave\aqty
	% extras
	\newcommand{\scriptr}{\mathcalligra{r}\,}
	\newcommand{\rvector}{\pmb{\mathcalligra{r}}\,}
	\newcommand{\propsim}{\mathbin{\ensurestackMath{
		\stackunder[2pt]{\propto}{\sim}
	}}}
	\newcommand{\simprop}{\mathbin{\ensurestackMath{
		\tilde{\propto}
	}}}
	\newcommand{\perc}[1]{\SI{#1}{\percent}}
	\newcommand{\longtwoheadrightarrow}{\mathrel{
		\begin{tikzpicture}
		\path [draw,-{
			>[length=.5ex,width=1.2ex]
			>[length=.5ex,width=1.2ex]}]%
				(0,0) -- (.6,0);
		\end{tikzpicture}
	}}
	\newcommand{\texstringonly}[1]{%
		\texorpdfstring{#1}{}%
	}
% Hacks
	% physics.sty <texmf-dist/tex/latex/physics/>
	% USER: more spacing around Dirac's middle vert
	\let\latexmiddle\middle
	\renewcommand{\middle}[1]{%
		\mspace{.8mu}\latexmiddle#1\mspace{.8mu}
	}

%%% ../.modules/preamble_notes.tex %%%
% Title
	\usepackage{titling}
	\setlength{\droptitle}{-2.25cm}
	\pretitle{\vspace{-5ex}%
		\begin{flushleft}\LARGE\bfseries%
	}
	\posttitle{
		\hfill\Large\ccbyncsajp
		\par\end{flushleft}\hrule%
	}
	\preauthor{\vspace{-1.2ex}%
		\flushleft\itshape%
	}
	\postauthor{\par}
	\predate{}
	\postdate{\vspace{-1.5ex}}
%	% section titles
%	\usepackage{titlesec}
%	\titleformat*{\section}{\large\bfseries}
% Utils
	\hypersetup{%
		colorlinks=true
		,linkcolor=DarkBlue
		,urlcolor=purple
		,linktoc=all
	}
	\let\qed\qednow
% Page
	\usepackage[
		vmargin=.120\paperheight % 4cm
		,hmargin=.135\paperwidth % 3cm
	]{geometry}
	\usepackage{changepage}
	% no widow
	\usepackage[defaultlines=2,all]{nowidow}
	\postdisplaypenalty=500
	\usepackage{enumitem} % incompatible with beamer
	\setlist{
		itemsep=0pt,topsep=0pt
%		,itemindent=*
	}
	\setlist[1]{
		labelindent=\parindent
		,leftmargin=*
%		,listparindent=\parindent
%		,leftmargin=0pt
	}
	% footnote
	\geometry{footnotesep=.8\baselineskip}     % pre footnote split
%	\setlength{\skip\footins}{.8\baselineskip} % pre footnote split, plain TeX
	\setlength{\footnotesep}{2.5\parskip}      % post footnote parskip
	\usepackage[bottom,splitrule]{footmisc}
	% justification
	\usepackage{ragged2e}
%	\flushbottom
%	\pagenumbering{arabic}
% Chinese
	% CJK underdot - incompatible with beamer
	\ifXeTeX
		\usepackage{xeCJKfntef}
		\xeCJKsetup{underdot = {
			boxdepth=0pt, format=\huge, depth=.3em
		}}
		\newcommand{\cjkdot}[1]{\CJKunderdot{#1}}
	\fi
%	\DeclareTextFontCommand{\textbf}{\sffamily}
% Toggles - etoolbox
	\newtoggle{draftMode}
	\newtoggle{publishMode}
	\newcommand{\hideInDraft}[1]{
		\iftoggle{draftMode}{}{#1}
	}
	\newcommand{\hideWhenPublish}[1]{
		\iftoggle{publishMode}{}{#1}
	}
% Captions
	\usepackage{caption}
	\captionsetup{labelfont+=bf
		,margin=3em
		,parskip=.3\baselineskip
%		,format=plain
%		,font+=small
%		,textfont+=it
%		,singlelinecheck=false
	}
	% ref name
	\renewcommand{\tableautorefname}{\tablename}
	\renewcommand{\figureautorefname}{\figurename}
% Personalizations
%	\newfontfamily\signature{Vladimir Script}
	\newcommand{\signature}{\calligra\relscale{.6}}
	\newcommand{\midquote}{{\signature May the Force be with you}}
	\newcommand{\newparagraph}{\pagebreak[3]
		\noindent%
%		\hrulefill%
		\hfil%
		~\raisebox{-4pt}[10pt][10pt]{%
			\leafright~~\midquote~~\leafleft%
		}~%
%		\hrulefill%
		\par\nopagebreak%
	}
% Header
	\usepackage{fancyhdr,lastpage}
	\pagestyle{fancy}
	\fancyhf{} % clear default settings
	\setlength{\headsep}{1.2\baselineskip}
	\cfoot{--\ \thepage\,/\,\pageref{LastPage}\ --}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}
	%% simple headings style
	\fancyhead[LO,RE]{\textsl{\textsc{\nouppercase{\leftmark}}}}
	\fancyhead[RO,LE]{\thepage}
%	%% fancy with logo
%	\lhead{
%		\hspace{.2em}
%		% logo
%		\vspace{-3ex}
%	}
%	\renewcommand{\headrulewidth}{0.1pt}
%	\renewcommand{\headrule}{\ifnum\value{page}=1\relax\else
%		\vbox to 2pt{\hbox to \headwidth{\dotfill}\vss}
%	\fi}
%	\fancypagestyle{titlepagestyle}{%
%		\fancyhead{}
%		\chead{
%			\vspace{2.5\baselineskip}
%			% logo
%	}

\newcommand{\legacyReference}{{
%	\clearpage\par
%	\quad\clearpage
	\renewcommand{\midquote}{\textbf{PAST WORK, AS TEMPLATE}}
	\newparagraph
}}

% Settings
%\counterwithout{equation}{section}
\mathtoolsset{showonlyrefs=false}
%\DeclareTextFontCommand{\textbf}{\sffamily}
\renewcommand{\midquote}{\quad}

% Spacing
\geometry{footnotesep=2\baselineskip} % pre footnote split
\setlength{\parskip}{.5\baselineskip}
\renewcommand{\baselinestretch}{1.15}

%Title
	\posttitle{
		\hfill\Large\ccbyncsajp
		\par\end{flushleft}%
		\vspace*{-.7ex}\hrule%
	}
	\preauthor{\vspace{-1.5ex}%
		\flushleft\itshape%
	}
	\postauthor{\hfill}
	\predate{\noindent\ttfamily Compiled @ }
	\postdate{\vspace{.5ex}}

	\author{\signature Bryan}
	\date{\today}

%% List
%	\setlist*{
%		listparindent=\parindent
%		,labelindent=\parindent
%		,parsep=\parskip
%		,itemsep=1.2\parskip
%	}

%%% ../.modules/basics/biblatex.tex %%%
% biblatex settings
% ... extracted from `pkuthss`
% ... biber usage:
%%%% !TeX TXS-program:bibliography = biber -l zh__pinyin --output-safechars %
%%%% % 注意末尾的 %, 适用于 TeXstudio

%% ... include bib:
%\addbibresource{*.bib}
%% ... print bib:
%\printbibliography[heading = bibintoc, title = {参考文献}]
%% bibintoc 选项使“参考文献”出现在目录中
%% 如果同时要使参考文献列表参与章节编号，
%% ... 可将“bibintoc”改为“bibnumbered”

\usepackage[
%	utf8
%	,style=caspervector
	,style=trad-unsrt
	,citestyle=numeric-comp
	,backend=biber % caspervector 必须使用 biber 后端
	,sorting=none  % 英、中文献排序，对比 ecnyt, cenyt
%	,maxcitenames=2    % aggressive et al
%	,uniquelist=false  % enforce et al despite degeneracy
%	,block=ragged
]{biblatex}

% 按学校要求设定参考文献列表中的条目之内及之间的距离
%\setlength{\bibitemsep}{3bp}
\setlength{\bibitemsep}{\parskip}

% linespread 值的计算过程可以参考 pkuthss.cls
%\renewcommand*{\bibfont}{\zihao{5}\linespread{1.27}\selectfont}
%\renewcommand*{\bibfont}{\linespread{1.12}\selectfont}

% No pagebreak in entry
\patchcmd{\bibsetup}{\interlinepenalty=5000}{\interlinepenalty=10000}{}{}

\let\simplecite\cite
\renewcommand{\cite}[1]{\parencite{#1}}

% authoryear style in \textcite
% ... see <texmf-dist/tex/latex/biblatex/cbx/numeric-comp.cbx>
% ... and <https://tex.stackexchange.com/a/307392>
\DeclareDelimFormat{finalnamedelim}{\addspace\&\space}
\DeclareDelimFormat{nameyeardelim}{\addspace}
\DeclareDelimFormat{namelabeldelim}{\addnbspace}

\makeatletter

% short arxiv number with hyperlink
\DeclareFieldFormat{eprint:arxivid}{%
  \ifhyperref
    {\mbox{\href{https://arxiv.org/\abx@arxivpath/#1}{\nolinkurl{#1}}}}%
    {\nolinkurl{#1}}%
}

\renewbibmacro*{textcite}{%
  \iffieldequals{namehash}{\cbx@lasthash}
    {\usebibmacro{cite:comp}}
    {\usebibmacro{cite:dump}%
     \ifbool{cbx:parens}
       {\printtext{\bibclosebracket}\global\boolfalse{cbx:parens}}
       {}%
     \iffirstcitekey
       {}
       {\textcitedelim}%
     \usebibmacro{cite:init}%
     \textsl{%
       \ifnameundef{labelname}
         {\printfield[citetitle]{labeltitle}}
         {\printnames{labelname}}
     }%                                         %%% slanted
     \setunit*{\addcomma\nameyeardelim}%        %%% add comma
%     \setunit{\nameyeardelim}%                 %%% add space
       \iffieldundef{eprint}
         {\printfield{year}}                    %%% add year
         {\printfield[eprint:arxivid]{eprint}}  %%% add eprint
     \setunit*{\printdelim{namelabeldelim}}%
     \printtext{\bibopenbracket}\global\booltrue{cbx:parens}%
     \ifnumequal{\value{citecount}}{1}
       {\usebibmacro{prenote}}
       {}%
     \usebibmacro{cite:comp}%
     \stepcounter{textcitecount}%
     \savefield{namehash}{\cbx@lasthash}}}
\makeatother

% DOI as hyperlink & titles
\ExecuteBibliographyOptions{doi=false}
\newbibmacro{string+doi}[1]{%
	\iffieldundef{doi}{#1}%
	{\href{https://dx.doi.org/\thefield{doi}}{#1}}%
}
\DeclareFieldFormat*{title}%
	{\usebibmacro{string+doi}{\mkbibemph{#1}}\isdot}
\DeclareFieldFormat*{journaltitle}%
	{\mkbibemph{#1}\adddot\nopunct}
\DeclareFieldFormat{titlecase}{#1} % no lower case (SentenceCase)

\DeclareFieldFormat[article]{volume}%
	{\mkbibbold{#1}\isdot}
\DeclareFieldFormat{date}%
	{\mkbibbold{#1}\isdot}
\DeclareFieldFormat{isbn}%
	{\mkbibacro{ISBN}\addcolon\addnbspace\smaller[0.5]#1\isdot}
\DeclareFieldFormat{url}%
	{\mkbibacro{URL}\addcolon\addnbspace\smaller[0.5]\url{#1}\isdot}
